<!doctype html>
<html lang="vi">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1" />
		<title>Chatbot Triết Học </title>
		<link href="image/1.png" rel="icon" type="image/png">
		<style>
			:root {
				--bg: #0b1020;
				--card: rgba(255, 255, 255, 0.06);
				--border: rgba(255, 255, 255, 0.12);
				--text: rgba(255, 255, 255, 0.92);
				--muted: rgba(255, 255, 255, 0.7);
				--accent: #7c5cff;
				--user: rgba(124, 92, 255, 0.18);
				--assistant: rgba(255, 255, 255, 0.07);
			}

			* {
				box-sizing: border-box;
			}

			body {
				margin: 0;
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
				background: radial-gradient(1200px 700px at 10% 10%, rgba(124, 92, 255, 0.25), transparent 60%),
					radial-gradient(900px 600px at 90% 20%, rgba(0, 196, 255, 0.18), transparent 55%),
					var(--bg);
				color: var(--text);
			}

			.wrap {
				max-width: 980px;
				margin: 0 auto;
				padding: 22px 16px;
			}

			header {
				display: flex;
				gap: 15px;
				align-items: center;
				justify-content: flex-start;
				margin-bottom: 14px;
			}

			.header-logo {
				width: 45px;
				height: 45px;
				border-radius: 50%;
				object-fit: cover;
				border: 2px solid var(--accent);
			}

			h1 {
				margin: 0;
				font-size: 18px;
				letter-spacing: 0.2px;
			}

			.hint {
				font-size: 12px;
				color: var(--muted);
			}

			.grid {
				display: grid;
				grid-template-columns: 1fr;
				gap: 12px;
			}

			.panel {
				background: var(--card);
				border: 1px solid var(--border);
				border-radius: 14px;
				overflow: hidden;
				backdrop-filter: blur(10px);
			}

			.topbar {
				display: flex;
				gap: 10px;
				align-items: center;
				padding: 12px;
				border-bottom: 1px solid var(--border);
			}

			label {
				font-size: 12px;
				color: var(--muted);
			}

			input[type="text"] {
				width: 100%;
				padding: 10px 12px;
				border-radius: 10px;
				border: 1px solid var(--border);
				background: rgba(0, 0, 0, 0.25);
				color: var(--text);
				outline: none;
			}

			.chat {
				height: min(66vh, 680px);
				overflow: auto;
				padding: 14px;
			}

			.msg {
				display: flex;
				gap: 12px;
				align-items: flex-start;
				max-width: 450px;
				padding: 10px 12px;
				border-radius: 12px;
				border: 1px solid var(--border);
				margin: 10px 0;
				line-height: 1.45;
			}

			.msg-avatar {
				width: 36px;
				height: 36px;
				border-radius: 50%;
				object-fit: cover;
				flex-shrink: 0;
				margin-top: 2px;
			}

			.msg-content {
				flex: 1;
				white-space: pre-wrap;
			}

			.msg.user {
				margin-left: auto;
				background: var(--user);
				flex-direction: row-reverse;
			}

			.msg.assistant {
				margin-right: auto;
				background: var(--assistant);
			}

			.composer {
				display: flex;
				gap: 10px;
				padding: 12px;
				border-top: 1px solid var(--border);
			}

			textarea {
				flex: 1;
				min-height: 44px;
				max-height: 140px;
				resize: vertical;
				padding: 10px 12px;
				border-radius: 12px;
				border: 1px solid var(--border);
				background: rgba(0, 0, 0, 0.25);
				color: var(--text);
				outline: none;
			}

			button {
				padding: 10px 14px;
				border-radius: 12px;
				border: 1px solid var(--border);
				background: linear-gradient(135deg, rgba(124, 92, 255, 0.9), rgba(0, 196, 255, 0.45));
				color: white;
				cursor: pointer;
				min-width: 120px;
				font-weight: 600;
			}

			button:disabled {
				opacity: 0.55;
				cursor: not-allowed;
			}

			.footer {
				padding: 10px 12px;
				font-size: 12px;
				color: var(--muted);
			}

			/* Ẩn các phần không cần thiết */
			.topbar {
				display: none !important;
			}

			header .hint {
				display: none !important;
			}
		</style>
	</head>
	<body>
		<div class="wrap">
			<header>
				<img src="image/logochatbotmln.png" alt="Logo" class="header-logo" onerror="this.style.display='none'">
				<h1>Chatbot Triết Học</h1>
				<div class="hint">Backend: <code>POST /api/search</code> (mặc định <code>http://localhost:5002/api/search</code>)</div>
			</header>

			<div class="grid">
				<div class="panel">
					<div class="topbar">
						<div style="min-width: 180px">
							<label for="endpoint">Backend URL</label>
							<input id="endpoint" type="text" value="http://localhost:5002/api/search" />
						</div>
						<div style="min-width: 200px">
							<label for="stream">Streaming</label>
							<div style="display:flex; gap:8px; align-items:center; margin-top:6px;">
								<input id="stream" type="checkbox" checked />
								<span class="hint">Hiện chữ ngay (SSE)</span>
							</div>
						</div>
						<div class="hint">
							Nếu bạn mở file này trực tiếp (file://), CORS có thể chặn. Cách ổn nhất là mở qua một web server (mình ghi bên dưới).
						</div>
					</div>

					<div id="chat" class="chat"></div>

					<div class="composer">
						<textarea id="input" placeholder="Nhập câu hỏi về triết học… (Enter để gửi, Shift+Enter xuống dòng)"></textarea>
						<button id="send">Gửi</button>
					</div>

					<div class="footer">
						Gợi ý: "Triết học là gì?", "Ba quy luật cơ bản của phép biện chứng là gì?", …
					</div>
				</div>
			</div>
		</div>

		<script>
			const $ = (id) => document.getElementById(id);
			const chatEl = $("chat");
			const inputEl = $("input");
			const endpointEl = $("endpoint");
			const streamEl = $("stream");
			const sendBtn = $("send");

			/** @type {{role:'user'|'assistant', content:string}[]} */
			const messages = [];

			function append(role, content) {
				const div = document.createElement("div");
				div.className = `msg ${role}`;
				
				// Tạo avatar
				const avatar = document.createElement("img");
				avatar.className = "msg-avatar";
				if (role === "user") {
					avatar.src = "image/user.png";
					avatar.alt = "User";
				} else {
					avatar.src = "image/logochatbotmln.png";
					avatar.alt = "Chatbot";
				}
				avatar.onerror = function() { this.style.display = 'none'; };
				
				// Tạo nội dung
				const contentDiv = document.createElement("div");
				contentDiv.className = "msg-content";
				contentDiv.textContent = content;
				
				div.appendChild(avatar);
				div.appendChild(contentDiv);
				chatEl.appendChild(div);
				chatEl.scrollTop = chatEl.scrollHeight;
				
				return contentDiv; // Trả về contentDiv để có thể cập nhật trong streaming
			}

			async function send() {
				const text = inputEl.value.trim();
				if (!text) return;

				messages.push({ role: "user", content: text });
				append("user", text);
				inputEl.value = "";

				sendBtn.disabled = true;
				const url = endpointEl.value.trim();

				try {
					const useStream = !!streamEl.checked;
					if (!useStream) {
						const res = await fetch(url, {
							method: "POST",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify(messages),
						});

						if (!res.ok) {
							const t = await res.text();
							append(
								"assistant",
								`Lỗi HTTP ${res.status}.\nBạn đang gọi: ${url}\n\nChi tiết: ${t.slice(0, 500)}`
							);
							return;
						}

						const data = await res.json();
						const content = data?.content ?? "(Không có content trong response)";
						messages.push({ role: "assistant", content });
						append("assistant", content);
						return;
					}

					// Streaming mode (SSE)
					const streamUrl = url.endsWith("/api/search") ? url + "/stream" : url;
					
					// Tạo message với avatar cho assistant
					const assistantDiv = document.createElement("div");
					assistantDiv.className = "msg assistant";
					
					const avatar = document.createElement("img");
					avatar.className = "msg-avatar";
					avatar.src = "image/logochatbotmln.png";
					avatar.alt = "Chatbot";
					avatar.onerror = function() { this.style.display = 'none'; };
					
					const contentDiv = document.createElement("div");
					contentDiv.className = "msg-content";
					contentDiv.textContent = "(Đang xử lý…)";
					
					assistantDiv.appendChild(avatar);
					assistantDiv.appendChild(contentDiv);
					chatEl.appendChild(assistantDiv);
					chatEl.scrollTop = chatEl.scrollHeight;

					const res = await fetch(streamUrl, {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify(messages),
					});

					if (!res.ok || !res.body) {
						const t = await res.text();
						contentDiv.textContent = `Lỗi HTTP ${res.status}.\nBạn đang gọi: ${streamUrl}\n\nChi tiết: ${t.slice(0, 500)}`;
						return;
					}

					const reader = res.body.getReader();
					const decoder = new TextDecoder("utf-8");
					let buffer = "";
					let finalText = "";
					let startedStreamingText = false;

					while (true) {
						const { value, done } = await reader.read();
						if (done) break;
						buffer += decoder.decode(value, { stream: true });

						// SSE frames are separated by double newline
						let idx;
						while ((idx = buffer.indexOf("\n\n")) !== -1) {
							const frame = buffer.slice(0, idx);
							buffer = buffer.slice(idx + 2);

							let event = "message";
							let dataLine = "";
							for (const line of frame.split("\n")) {
								if (line.startsWith("event:")) event = line.slice(6).trim();
								if (line.startsWith("data:")) dataLine += line.slice(5).trim();
							}
							const dataText = dataLine.replace(/\\n/g, "\n");

							if (event === "status") {
								if (!startedStreamingText) contentDiv.textContent = `(Đang ${dataText}…)`;
							} else if (event === "chunk") {
								if (!startedStreamingText) {
									contentDiv.textContent = "";
									startedStreamingText = true;
								}
								contentDiv.textContent += dataText;
							} else if (event === "final") {
								finalText = dataText;
								contentDiv.textContent = finalText;
							} else if (event === "error") {
								contentDiv.textContent = `Lỗi: ${dataText}`;
							}
							chatEl.scrollTop = chatEl.scrollHeight;
						}
					}

					if (finalText) {
						messages.push({ role: "assistant", content: finalText });
					} else {
						messages.push({ role: "assistant", content: contentDiv.textContent });
					}
				} catch (e) {
					const isFile = window.location.protocol === "file:";
					append(
						"assistant",
						[
							"Không gọi được backend.",
							"",
							"- Backend đã chạy chưa? (mở http://localhost:5002/ phải thấy status ok)",
							"- URL đúng chưa? (mặc định: http://localhost:5002/api/search)",
							isFile
								? "- Bạn đang mở UI bằng file:// nên trình duyệt có thể chặn fetch. Hãy mở UI qua web server: python -m http.server 3000 rồi vào http://localhost:3000/chatbot.html"
								: "- Nếu UI và backend khác port/domain, có thể bị CORS. (CORS đã bật ở backend, nhưng file:// thường vẫn bị chặn)",
							"",
							`Chi tiết: ${e}`,
						].join("\n")
					);
				} finally {
					sendBtn.disabled = false;
				}
			}

			sendBtn.addEventListener("click", send);
			inputEl.addEventListener("keydown", (ev) => {
				if (ev.key === "Enter" && !ev.shiftKey) {
					ev.preventDefault();
					send();
				}
			});

			// greeting
			append(
				"assistant",
				"Xin chào! Mình là chatbot triết học. Bạn hãy đặt câu hỏi về Triết học Mác-Lênin nhé."
			);
		</script>
	</body>
</html>